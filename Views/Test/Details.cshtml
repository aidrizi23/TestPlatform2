@* $1$ #1# *@
@* $1$ #1# *@
@* $1$ #1# *@
@* $1$ @using Microsoft.AspNetCore.Mvc.TagHelpers #1# *@
@* $1$ @using TestPlatform2.Data.Questions #1# *@
@* $1$ @model TestPlatform2.Data.Test #1# *@
@* $1$ #1# *@
@* $1$ @{ #1# *@
@* $1$     ViewData["Title"] = "Test Details"; #1# *@
@* $1$ } #1# *@
@* $1$ #1# *@
@* $1$ <h2>Test Details</h2> #1# *@
@* $1$ #1# *@
@* $1$ <div class="card mb-4"> #1# *@
@* $1$     <div class="card-body"> #1# *@
@* $1$         <h4 class="card-title">@Model.TestName</h4> #1# *@
@* $1$ #1# *@
@* $1$         <dl class="row"> #1# *@
@* $1$             <dt class="col-sm-3">Description</dt> #1# *@
@* $1$             <dd class="col-sm-9">@Model.Description</dd> #1# *@
@* $1$ #1# *@
@* $1$             <dt class="col-sm-3">Randomize Questions</dt> #1# *@
@* $1$             <dd class="col-sm-9">@(Model.RandomizeQuestions ? "Yes" : "No")</dd> #1# *@
@* $1$ #1# *@
@* $1$             <dt class="col-sm-3">Time Limit</dt> #1# *@
@* $1$             <dd class="col-sm-9">@Model.TimeLimit minutes</dd> #1# *@
@* $1$ #1# *@
@* $1$             <dt class="col-sm-3">Max Attempts</dt> #1# *@
@* $1$             <dd class="col-sm-9">@Model.MaxAttempts</dd> #1# *@
@* $1$ #1# *@
@* $1$             <dt class="col-sm-3">Created By</dt> #1# *@
@* $1$             <dd class="col-sm-9">@Model.User?.UserName</dd> #1# *@
@* $1$         </dl> #1# *@
@* $1$ #1# *@
@* $1$         <!-- Question Type Buttons --> #1# *@
@* $1$         <div class="mb-4"> #1# *@
@* $1$             <h5>Add Questions:</h5> #1# *@
@* $1$             <div class="btn-group"> #1# *@
@* $1$                 <a asp-controller="Question" asp-action="CreateMultipleChoice" asp-route-testId="@Model.Id" class="btn btn-primary me-2"> #1# *@
@* $1$                     <i class="fas fa-list-ul"></i> Multiple Choice #1# *@
@* $1$                 </a> #1# *@
@* $1$                 <a asp-controller="Question" asp-action="CreateTrueFalse" asp-route-testId="@Model.Id" class="btn btn-success me-2"> #1# *@
@* $1$                     <i class="fas fa-check-circle"></i> True/False #1# *@
@* $1$                 </a> #1# *@
@* $1$                 <a asp-controller="Question" asp-action="CreateShortAnswer" asp-route-testId="@Model.Id" class="btn btn-info me-2"> #1# *@
@* $1$                     <i class="fas fa-pen"></i> Short Answer #1# *@
@* $1$                 </a> #1# *@
@* $1$             </div> #1# *@
@* $1$         </div> #1# *@
@* $1$ #1# *@
@* $1$         <!-- Navigation Buttons --> #1# *@
@* $1$         <div class="mt-3"> #1# *@
@* $1$             <a asp-action="Index" class="btn btn-secondary"> #1# *@
@* $1$                 <i class="fas fa-arrow-left"></i> Back to Tests #1# *@
@* $1$             </a> #1# *@
@* $1$             <a asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-warning ms-2"> #1# *@
@* $1$                 <i class="fas fa-edit"></i> Edit Test #1# *@
@* $1$             </a> #1# *@
@* $1$             <button type="button" class="btn btn-danger ms-2" onclick="deleteTest('@Model.Id')"> #1# *@
@* $1$                 <i class="fas fa-trash"></i> Delete Test #1# *@
@* $1$             </button> #1# *@
@* $1$         </div> #1# *@
@* $1$     </div> #1# *@
@* $1$ </div> #1# *@
@* $1$ #1# *@
@* $1$ <!-- List of Existing Questions --> #1# *@
@* $1$ @if (Model.Questions?.Any() == true) #1# *@
@* $1$ { #1# *@
@* $1$     <div class="card"> #1# *@
@* $1$         <div class="card-body"> #1# *@
@* $1$             <h5 class="card-title">Questions</h5> #1# *@
@* $1$             <div class="list-group"> #1# *@
@* $1$                 @foreach (var question in Model.Questions.OrderBy(q => q.Position)) #1# *@
@* $1$                 { #1# *@
@* $1$                     <div class="list-group-item d-flex justify-content-between align-items-center"> #1# *@
@* $1$                         <div> #1# *@
@* $1$                             <span class="badge bg-secondary me-2">@question.Position</span> #1# *@
@* $1$                             @question.Text #1# *@
@* $1$                             <span class="badge bg-primary ms-2">@question.Points pts</span> #1# *@
@* $1$                             @{ #1# *@
@* $1$                                 var questionType = question switch #1# *@
@* $1$                                 { #1# *@
@* $1$                                     TrueFalseQuestion => "True/False", #1# *@
@* $1$                                     MultipleChoiceQuestion => "Multiple Choice", #1# *@
@* $1$                                     ShortAnswerQuestion => "Short Answer", #1# *@
@* $1$                                     _ => "Unknown" #1# *@
@* $1$                                 }; #1# *@
@* $1$                             } #1# *@
@* $1$                             <span class="badge bg-info ms-2">@questionType</span> #1# *@
@* $1$                         </div> #1# *@
@* $1$                         <div class="btn-group"> #1# *@
@* $1$                             <a asp-controller="Question" asp-action="Edit" asp-route-id="@question.Id" class="btn btn-sm btn-warning"> #1# *@
@* $1$                                 <i class="fas fa-edit"></i> #1# *@
@* $1$                             </a> #1# *@
@* $1$                             <button type="button" class="btn btn-sm btn-danger" onclick="confirmDeleteQuestion('@question.Id')"> #1# *@
@* $1$                                 <i class="fas fa-trash"></i> #1# *@
@* $1$                             </button> #1# *@
@* $1$                         </div> #1# *@
@* $1$                     </div> #1# *@
@* $1$                 } #1# *@
@* $1$             </div> #1# *@
@* $1$         </div> #1# *@
@* $1$     </div> #1# *@
@* $1$ } #1# *@
@* $1$ #1# *@
@* $1$ #1# *@
@* $1$ <!-- Send Invites Section --> #1# *@
@* $1$ <div class="card mt-4"> #1# *@
@* $1$     <div class="card-body"> #1# *@
@* $1$         <h5 class="card-title">Send Invites to Students</h5> #1# *@
@* $1$ #1# *@
@* $1$         <!-- Form to Add Emails --> #1# *@
@* $1$         <form id="addEmailsForm"> #1# *@
@* $1$             <div class="mb-3"> #1# *@
@* $1$                 <label for="emails" class="form-label">Enter student emails (comma-separated):</label> #1# *@
@* $1$                 <textarea id="emails" name="emails" class="form-control" rows="3" placeholder="e.g., student1@example.com, student2@example.com"></textarea> #1# *@
@* $1$             </div> #1# *@
@* $1$             <button type="button" class="btn btn-primary" onclick="addEmails()"> #1# *@
@* $1$                 <i class="fas fa-plus"></i> Add Emails #1# *@
@* $1$             </button> #1# *@
@* $1$         </form> #1# *@
@* $1$ #1# *@
@* $1$         <!-- List of Added Emails --> #1# *@
@* $1$         <div class="mt-4"> #1# *@
@* $1$             <h6>Emails to Invite:</h6> #1# *@
@* $1$             <ul id="emailList" class="list-group"> #1# *@
@* $1$                 <!-- Emails will be dynamically added here --> #1# *@
@* $1$             </ul> #1# *@
@* $1$         </div> #1# *@
@* $1$ #1# *@
@* $1$         <!-- Button to Send Invites --> #1# *@
@* $1$         <div class="mt-3"> #1# *@
@* $1$             <button type="button" class="btn btn-success" onclick="sendInvites('@Model.Id')"> #1# *@
@* $1$                 <i class="fas fa-paper-plane"></i> Send Invites #1# *@
@* $1$             </button> #1# *@
@* $1$         </div> #1# *@
@* $1$     </div> #1# *@
@* $1$ </div> #1# *@
@* $1$ #1# *@
@* $1$ #1# *@
@* $1$ @section Scripts { #1# *@
@* $1$     @{await Html.RenderPartialAsync("_ValidationScriptsPartial");} #1# *@
@* $1$ #1# *@
@* $1$     <script> #1# *@
@* $1$         function confirmDeleteQuestion(id) { #1# *@
@* $1$             if (confirm('Are you sure you want to delete this question?')) { #1# *@
@* $1$                 $.ajax({ #1# *@
@* $1$                     url: '@Url.Action("Delete", "Question")/' + id, #1# *@
@* $1$                     type: 'POST', #1# *@
@* $1$                     success: function() { #1# *@
@* $1$                         location.reload(); #1# *@
@* $1$                     }, #1# *@
@* $1$                     error: function() { #1# *@
@* $1$                         alert('Error deleting question'); #1# *@
@* $1$                     } #1# *@
@* $1$                 }); #1# *@
@* $1$             } #1# *@
@* $1$         } #1# *@
@* $1$ #1# *@
@* $1$         function deleteTest(id) { #1# *@
@* $1$             if (confirm('Are you sure you want to delete this test and all its questions?')) { #1# *@
@* $1$                 window.location.href = '@Url.Action("Delete", "Test")/' + id; #1# *@
@* $1$             } #1# *@
@* $1$         } #1# *@
@* $1$     </script> #1# *@
@* $1$ #1# *@
@* $1$     <script> #1# *@
@* $1$         // Array to store emails #1# *@
@* $1$         let emails = []; #1# *@
@* $1$ #1# *@
@* $1$         // Function to add emails to the list #1# *@
@* $1$         function addEmails() { #1# *@
@* $1$             const emailInput = document.getElementById('emails').value; #1# *@
@* $1$             const newEmails = emailInput.split(',').map(email => email.trim()).filter(email => email); #1# *@
@* $1$ #1# *@
@* $1$             // Add new emails to the array #1# *@
@* $1$             emails = [...new Set([...emails, ...newEmails])]; #1# *@
@* $1$ #1# *@
@* $1$             // Clear the input #1# *@
@* $1$             document.getElementById('emails').value = ''; #1# *@
@* $1$ #1# *@
@* $1$             // Update the email list UI #1# *@
@* $1$             updateEmailList(); #1# *@
@* $1$         } #1# *@
@* $1$ #1# *@
@* $1$         // Function to update the email list UI #1# *@
@* $1$         function updateEmailList() { #1# *@
@* $1$             const emailList = document.getElementById('emailList'); #1# *@
@* $1$             emailList.innerHTML = ''; // Clear the list #1# *@
@* $1$ #1# *@
@* $1$             emails.forEach(email => { #1# *@
@* $1$                 const listItem = document.createElement('li'); #1# *@
@* $1$                 listItem.className = 'list-group-item d-flex justify-content-between align-items-center'; #1# *@
@* $1$                 listItem.textContent = email; #1# *@
@* $1$ #1# *@
@* $1$                 // Add a remove button #1# *@
@* $1$                 const removeButton = document.createElement('button'); #1# *@
@* $1$                 removeButton.className = 'btn btn-sm btn-danger'; #1# *@
@* $1$                 removeButton.innerHTML = '<i class="fas fa-times"></i>'; #1# *@
@* $1$                 removeButton.onclick = () => removeEmail(email); #1# *@
@* $1$ #1# *@
@* $1$                 listItem.appendChild(removeButton); #1# *@
@* $1$                 emailList.appendChild(listItem); #1# *@
@* $1$             }); #1# *@
@* $1$         } #1# *@
@* $1$ #1# *@
@* $1$         // Function to remove an email from the list #1# *@
@* $1$         function removeEmail(email) { #1# *@
@* $1$             emails = emails.filter(e => e !== email); #1# *@
@* $1$             updateEmailList(); #1# *@
@* $1$         } #1# *@
@* $1$ #1# *@
@* $1$         // Function to send invites #1# *@
@* $1$         function sendInvites(testId) { #1# *@
@* $1$             if (emails.length === 0) { #1# *@
@* $1$                 alert('Please add at least one email.'); #1# *@
@* $1$                 return; #1# *@
@* $1$             } #1# *@
@* $1$ #1# *@
@* $1$             // Send the emails to the server #1# *@
@* $1$             fetch(`/TestInvite/SendInvites?testId=${testId}`, { #1# *@
@* $1$                 method: 'POST', #1# *@
@* $1$                 headers: { #1# *@
@* $1$                     'Content-Type': 'application/json', #1# *@
@* $1$                 }, #1# *@
@* $1$                 body: JSON.stringify(emails), #1# *@
@* $1$             }) #1# *@
@* $1$                 .then(response => { #1# *@
@* $1$                     if (response.ok) { #1# *@
@* $1$                         alert('Invites sent successfully!'); #1# *@
@* $1$                         emails = []; // Clear the email list #1# *@
@* $1$                         updateEmailList(); // Update the UI #1# *@
@* $1$                     } else { #1# *@
@* $1$                         alert('Error sending invites.'); #1# *@
@* $1$                     } #1# *@
@* $1$                 }) #1# *@
@* $1$                 .catch(error => { #1# *@
@* $1$                     console.error('Error:', error); #1# *@
@* $1$                     alert('Error sending invites.'); #1# *@
@* $1$                 }); #1# *@
@* $1$         } #1# *@
@* $1$     </script> #1# *@
@* $1$ } #1# *@
@* *@
@* *@
@* *@
@* @using Microsoft.AspNetCore.Mvc.TagHelpers *@
@* @using TestPlatform2.Data.Questions *@
@* @model TestPlatform2.Data.Test *@
@* @{ *@
@*     ViewData["Title"] = "Test Details"; *@
@* } *@
@* *@
@* <!-- Page Title --> *@
@* <h2 class="text-center mb-4">Test Details</h2> *@
@* *@
@* <div class="container"> *@
@*     <!-- Test Details Card --> *@
@*     <div class="card shadow mb-5"> *@
@*         <div class="card-header bg-primary text-white"> *@
@*             <h4 class="mb-0">@Model.TestName</h4> *@
@*         </div> *@
@*         <div class="card-body"> *@
@*             <dl class="row"> *@
@*                 <dt class="col-sm-3 font-weight-bold">Description</dt> *@
@*                 <dd class="col-sm-9">@Model.Description</dd> *@
@*                 <dt class="col-sm-3 font-weight-bold">Randomize Questions</dt> *@
@*                 <dd class="col-sm-9">@(Model.RandomizeQuestions ? "Yes" : "No")</dd> *@
@*                 <dt class="col-sm-3 font-weight-bold">Time Limit</dt> *@
@*                 <dd class="col-sm-9">@Model.TimeLimit minutes</dd> *@
@*                 <dt class="col-sm-3 font-weight-bold">Max Attempts</dt> *@
@*                 <dd class="col-sm-9">@Model.MaxAttempts</dd> *@
@*                 <dt class="col-sm-3 font-weight-bold">Created By</dt> *@
@*                 <dd class="col-sm-9">@Model.User?.UserName</dd> *@
@*             </dl> *@
@*         </div> *@
@*         <div class="card-footer d-flex justify-content-between align-items-center"> *@
@*             <a asp-action="Index" class="btn btn-secondary"> *@
@*                 <i class="fas fa-arrow-left"></i> Back to Tests *@
@*             </a> *@
@*             <div> *@
@*                 <a asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-warning me-2"> *@
@*                     <i class="fas fa-edit"></i> Edit Test *@
@*                 </a> *@
@*                 <button type="button" class="btn btn-danger" onclick="deleteTest('@Model.Id')"> *@
@*                     <i class="fas fa-trash"></i> Delete Test *@
@*                 </button> *@
@*             </div> *@
@*         </div> *@
@*     </div> *@
@* *@
@*     <!-- Add Questions Section --> *@
@*     <div class="card shadow mb-5"> *@
@*         <div class="card-header bg-success text-white"> *@
@*             <h5 class="mb-0">Add Questions</h5> *@
@*         </div> *@
@*         <div class="card-body"> *@
@*             <div class="btn-group w-100"> *@
@*                 <a asp-controller="Question" asp-action="CreateMultipleChoice" asp-route-testId="@Model.Id" class="btn btn-primary w-100 me-2"> *@
@*                     <i class="fas fa-list-ul"></i> Multiple Choice *@
@*                 </a> *@
@*                 <a asp-controller="Question" asp-action="CreateTrueFalse" asp-route-testId="@Model.Id" class="btn btn-success w-100 me-2"> *@
@*                     <i class="fas fa-check-circle"></i> True/False *@
@*                 </a> *@
@*                 <a asp-controller="Question" asp-action="CreateShortAnswer" asp-route-testId="@Model.Id" class="btn btn-info w-100"> *@
@*                     <i class="fas fa-pen"></i> Short Answer *@
@*                 </a> *@
@*             </div> *@
@*         </div> *@
@*     </div> *@
@* *@
@*     <!-- Existing Questions List --> *@
@*     @if (Model.Questions?.Any() == true) *@
@*     { *@
@*         <div class="card shadow mb-5"> *@
@*             <div class="card-header bg-info text-white"> *@
@*                 <h5 class="mb-0">Questions</h5> *@
@*             </div> *@
@*             <ul class="list-group list-group-flush"> *@
@*                 @foreach (var question in Model.Questions.OrderBy(q => q.Position)) *@
@*                 { *@
@*                     <li class="list-group-item d-flex justify-content-between align-items-center"> *@
@*                         <div> *@
@*                             <span class="badge bg-secondary me-2">@question.Position</span> *@
@*                             <strong>@question.Text</strong> *@
@*                             <span class="badge bg-primary ms-2">@question.Points pts</span> *@
@*                             @{ *@
@*                                 var questionType = question switch *@
@*                                 { *@
@*                                     TrueFalseQuestion => "True/False", *@
@*                                     MultipleChoiceQuestion => "Multiple Choice", *@
@*                                     ShortAnswerQuestion => "Short Answer", *@
@*                                     _ => "Unknown" *@
@*                                 }; *@
@*                             } *@
@*                             <span class="badge bg-info ms-2">@questionType</span> *@
@*                         </div> *@
@*                         <div class="btn-group"> *@
@*                             <a asp-controller="Question" asp-action="Edit" asp-route-id="@question.Id" class="btn btn-sm btn-warning"> *@
@*                                 <i class="fas fa-edit"></i> *@
@*                             </a> *@
@*                             <button type="button" class="btn btn-sm btn-danger" onclick="confirmDeleteQuestion('@question.Id')"> *@
@*                                 <i class="fas fa-trash"></i> *@
@*                             </button> *@
@*                         </div> *@
@*                     </li> *@
@*                 } *@
@*             </ul> *@
@*         </div> *@
@*     } *@
@* *@
@*     <!-- Send Invites Section --> *@
@*     <div class="card shadow mb-5"> *@
@*         <div class="card-header bg-dark text-white"> *@
@*             <h5 class="mb-0">Send Invites to Students</h5> *@
@*         </div> *@
@*         <div class="card-body"> *@
@*             <!-- Form to Specify Number of Emails --> *@
@*             <form id="emailForm"> *@
@*                 <div class="mb-3"> *@
@*                     <label for="emailCount" class="form-label">Enter the number of students:</label> *@
@*                     <input type="number" id="emailCount" name="emailCount" class="form-control" min="1" placeholder="e.g., 5" required> *@
@*                 </div> *@
@*                 <button type="button" class="btn btn-primary me-2" onclick="generateEmailFields()"> *@
@*                     <i class="fas fa-plus"></i> Generate Email Fields *@
@*                 </button> *@
@*                 <button type="button" class="btn btn-secondary" onclick="addSingleField()"> *@
@*                     <i class="fas fa-user-plus"></i> Add Single Field *@
@*                 </button> *@
@*             </form> *@
@* *@
@*             <!-- Dynamic Email Input Fields --> *@
@*             <div id="emailInputsContainer" class="mt-4" style="display: none;"> *@
@*                 <h6>Enter Student Emails:</h6> *@
@*                 <form id="emailInputsForm" novalidate> *@
@*                     <div id="emailInputs" class="mb-3"></div> *@
@*                     <button type="button" class="btn btn-success" onclick="sendInvites('@Model.Id')"> *@
@*                         <i class="fas fa-paper-plane"></i> Send Invites *@
@*                     </button> *@
@*                 </form> *@
@*             </div> *@
@*         </div> *@
@*     </div> *@
@* </div> *@
@* *@
@* @section Scripts { *@
@*     @{await Html.RenderPartialAsync("_ValidationScriptsPartial");} *@
@*     <script> *@
@*         // Function to confirm question deletion *@
@*         function confirmDeleteQuestion(id) { *@
@*             if (confirm('Are you sure you want to delete this question?')) { *@
@*                 $.ajax({ *@
@*                     url: '@Url.Action("Delete", "Question")/' + id, *@
@*                     type: 'POST', *@
@*                     success: function () { *@
@*                         location.reload(); *@
@*                     }, *@
@*                     error: function () { *@
@*                         alert('Error deleting question'); *@
@*                     } *@
@*                 }); *@
@*             } *@
@*         } *@
@* *@
@*         // Function to confirm test deletion *@
@*         function deleteTest(id) { *@
@*             if (confirm('Are you sure you want to delete this test and all its questions?')) { *@
@*                 window.location.href = '@Url.Action("Delete", "Test")/' + id; *@
@*             } *@
@*         } *@
@* *@
@*         // Function to generate email input fields dynamically *@
@*         function generateEmailFields() { *@
@*             const emailCount = document.getElementById('emailCount').value; *@
@* *@
@*             if (!emailCount || emailCount < 1) { *@
@*                 alert('Please enter a valid number of students.'); *@
@*                 return; *@
@*             } *@
@* *@
@*             const emailInputsDiv = document.getElementById('emailInputs'); *@
@* *@
@*             // Generate email input fields *@
@*             for (let i = 1; i <= emailCount; i++) { *@
@*                 addSingleField(emailInputsDiv); *@
@*             } *@
@* *@
@*             // Show the container *@
@*             document.getElementById('emailInputsContainer').style.display = 'block'; *@
@*         } *@
@* *@
@*         // Function to add a single email field *@
@*         function addSingleField(container = null) { *@
@*             const emailInputsDiv = container || document.getElementById('emailInputs'); *@
@* *@
@*             const emailInputDiv = document.createElement('div'); *@
@*             emailInputDiv.className = 'input-group mb-2'; *@
@* *@
@*             // Generate unique ID for each input field *@
@*             const uniqueId = `email-${Date.now()}`; *@
@* *@
@*             emailInputDiv.innerHTML = ` *@
@*                 <span class="input-group-text">Student</span> *@
@*                 <input type="email" id="${uniqueId}" class="form-control" placeholder="Enter email" required> *@
@*                 <button type="button" class="btn btn-danger" onclick="removeField(this)"> *@
@*                     <i class="fas fa-times"></i> *@
@*                 </button> *@
@*             `; *@
@*             emailInputsDiv.appendChild(emailInputDiv); *@
@* *@
@*             // Show the container *@
@*             document.getElementById('emailInputsContainer').style.display = 'block'; *@
@*         } *@
@* *@
@*         // Function to remove an email field *@
@*         function removeField(button) { *@
@*             const emailInputDiv = button.closest('.input-group'); *@
@*             emailInputDiv.remove(); *@
@*         } *@
@* *@
@*         // Function to send invites *@
@*         function sendInvites(testId) { *@
@*             const emailInputsForm = document.getElementById('emailInputsForm'); *@
@*             const emailInputs = emailInputsForm.querySelectorAll('input[type="email"]'); *@
@*             const emails = []; *@
@* *@
@*             // Check if the form is valid *@
@*             let isValid = true; *@
@*             emailInputs.forEach(input => { *@
@*                 if (!input.checkValidity()) { *@
@*                     isValid = false; *@
@*                     input.reportValidity(); // Trigger browser validation message *@
@*                 } else { *@
@*                     emails.push(input.value.trim()); *@
@*                 } *@
@*             }); *@
@* *@
@*             if (!isValid || emails.length === 0) { *@
@*                 return; *@
@*             } *@
@* *@
@*             // Send the emails to the server *@
@*             fetch(`/TestInvite/SendInvites?testId=${testId}`, { *@
@*                 method: 'POST', *@
@*                 headers: { *@
@*                     'Content-Type': 'application/json', *@
@*                 }, *@
@*                 body: JSON.stringify(emails), *@
@*             }) *@
@*                 .then(response => { *@
@*                     if (response.ok) { *@
@*                         alert('Invites sent successfully!'); *@
@*                     } else { *@
@*                         alert('Error sending invites.'); *@
@*                     } *@
@*                 }) *@
@*                 .catch(error => { *@
@*                     console.error('Error:', error); *@
@*                     alert('Error sending invites.'); *@
@*                 }); *@
@*         } *@
@*     </script> *@
@* } *@



@using Microsoft.AspNetCore.Mvc.TagHelpers
@using TestPlatform2.Data.Questions
@model TestPlatform2.Data.Test

@{
    ViewData["Title"] = "Test Details";
}

<!-- Page Title -->
<h2 class="text-center mb-4">Test Details</h2>

<div class="container">
    <!-- Test Details Card -->
    <div class="card shadow mb-5">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0">@Model.TestName</h4>
        </div>
        <div class="card-body">
            <dl class="row">
                <dt class="col-sm-3 font-weight-bold">Description</dt>
                <dd class="col-sm-9">@Model.Description</dd>
                <dt class="col-sm-3 font-weight-bold">Randomize Questions</dt>
                <dd class="col-sm-9">@(Model.RandomizeQuestions ? "Yes" : "No")</dd>
                <dt class="col-sm-3 font-weight-bold">Time Limit</dt>
                <dd class="col-sm-9">@Model.TimeLimit minutes</dd>
                <dt class="col-sm-3 font-weight-bold">Max Attempts</dt>
                <dd class="col-sm-9">@Model.MaxAttempts</dd>
                <dt class="col-sm-3 font-weight-bold">Created By</dt>
                <dd class="col-sm-9">@Model.User?.UserName</dd>

                <!-- NEW: Display the number of questions for each type -->
                <dt class="col-sm-3 font-weight-bold">Multiple Choice Questions</dt>
                <dd class="col-sm-9">@Model.MultipleChoiceQuestionsToShow</dd>

                <dt class="col-sm-3 font-weight-bold">True/False Questions</dt>
                <dd class="col-sm-9">@Model.TrueFalseQuestionsToShow</dd>

                <dt class="col-sm-3 font-weight-bold">Short Answer Questions</dt>
                <dd class="col-sm-9">@Model.ShortAnswerQuestionsToShow</dd>
            </dl>
        </div>
        <div class="card-footer d-flex justify-content-between align-items-center">
            <a asp-action="Index" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Back to Tests
            </a>
            <div>
                <a asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-warning me-2">
                    <i class="fas fa-edit"></i> Edit Test
                </a>
                <button type="button" class="btn btn-danger" onclick="deleteTest('@Model.Id')">
                    <i class="fas fa-trash"></i> Delete Test
                </button>
            </div>
        </div>
    </div>

    <!-- Add Questions Section -->
    <div class="card shadow mb-5">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0">Add Questions</h5>
        </div>
        <div class="card-body">
            <div class="btn-group w-100">
                <a asp-controller="Question" asp-action="CreateMultipleChoice" asp-route-testId="@Model.Id" class="btn btn-primary w-100 me-2">
                    <i class="fas fa-list-ul"></i> Multiple Choice
                </a>
                <a asp-controller="Question" asp-action="CreateTrueFalse" asp-route-testId="@Model.Id" class="btn btn-success w-100 me-2">
                    <i class="fas fa-check-circle"></i> True/False
                </a>
                <a asp-controller="Question" asp-action="CreateShortAnswer" asp-route-testId="@Model.Id" class="btn btn-info w-100">
                    <i class="fas fa-pen"></i> Short Answer
                </a>
            </div>
        </div>
    </div>

    <!-- Existing Questions List -->
    @if (Model.Questions?.Any() == true)
    {
        <div class="card shadow mb-5">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">Questions</h5>
            </div>
            <ul class="list-group list-group-flush">
                @foreach (var question in Model.Questions.OrderBy(q => q.Position))
                {
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <span class="badge bg-secondary me-2">@question.Position</span>
                            <strong>@question.Text</strong>
                            <span class="badge bg-primary ms-2">@question.Points pts</span>
                            @{
                                var questionType = question switch
                                {
                                    TrueFalseQuestion => "True/False",
                                    MultipleChoiceQuestion => "Multiple Choice",
                                    ShortAnswerQuestion => "Short Answer",
                                    _ => "Unknown"
                                };
                            }
                            <span class="badge bg-info ms-2">@questionType</span>
                        </div>
                        <div class="btn-group">
                            <a asp-controller="Question" asp-action="Edit" asp-route-id="@question.Id" class="btn btn-sm btn-warning">
                                <i class="fas fa-edit"></i>
                            </a>
                            <button type="button" class="btn btn-sm btn-danger" onclick="confirmDeleteQuestion('@question.Id')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </li>
                }
            </ul>
        </div>
    }

    <!-- Send Invites Section -->
    <div class="card shadow mb-5">
        <div class="card-header bg-dark text-white">
            <h5 class="mb-0">Send Invites to Students</h5>
        </div>
        <div class="card-body">
            <!-- Form to Specify Number of Emails -->
            <form id="emailForm">
                <div class="mb-3">
                    <label for="emailCount" class="form-label">Enter the number of students:</label>
                    <input type="number" id="emailCount" name="emailCount" class="form-control" min="1" placeholder="e.g., 5" required>
                </div>
                <button type="button" class="btn btn-primary me-2" onclick="generateEmailFields()">
                    <i class="fas fa-plus"></i> Generate Email Fields
                </button>
                <button type="button" class="btn btn-secondary" onclick="addSingleField()">
                    <i class="fas fa-user-plus"></i> Add Single Field
                </button>
            </form>

            <!-- Dynamic Email Input Fields -->
            <div id="emailInputsContainer" class="mt-4" style="display: none;">
                <h6>Enter Student Emails:</h6>
                <form id="emailInputsForm" novalidate>
                    <div id="emailInputs" class="mb-3"></div>
                    <button type="button" class="btn btn-success" onclick="sendInvites('@Model.Id')">
                        <i class="fas fa-paper-plane"></i> Send Invites
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script>
        // Function to confirm question deletion
        function confirmDeleteQuestion(id) {
            if (confirm('Are you sure you want to delete this question?')) {
                $.ajax({
                    url: '@Url.Action("Delete", "Question")/' + id,
                    type: 'POST',
                    success: function () {
                        location.reload();
                    },
                    error: function () {
                        alert('Error deleting question');
                    }
                });
            }
        }

        // Function to confirm test deletion
        function deleteTest(id) {
            if (confirm('Are you sure you want to delete this test and all its questions?')) {
                window.location.href = '@Url.Action("Delete", "Test")/' + id;
            }
        }

        // Function to generate email input fields dynamically
        function generateEmailFields() {
            const emailCount = document.getElementById('emailCount').value;

            if (!emailCount || emailCount < 1) {
                alert('Please enter a valid number of students.');
                return;
            }

            const emailInputsDiv = document.getElementById('emailInputs');

            // Generate email input fields
            for (let i = 1; i <= emailCount; i++) {
                addSingleField(emailInputsDiv);
            }

            // Show the container
            document.getElementById('emailInputsContainer').style.display = 'block';
        }

        // Function to add a single email field
        function addSingleField(container = null) {
            const emailInputsDiv = container || document.getElementById('emailInputs');

            const emailInputDiv = document.createElement('div');
            emailInputDiv.className = 'input-group mb-2';

            // Generate unique ID for each input field
            const uniqueId = `email-${Date.now()}`;

            emailInputDiv.innerHTML = `
                <span class="input-group-text">Student</span>
                <input type="email" id="${uniqueId}" class="form-control" placeholder="Enter email" required>
                <button type="button" class="btn btn-danger" onclick="removeField(this)">
                    <i class="fas fa-times"></i>
                </button>
            `;
            emailInputsDiv.appendChild(emailInputDiv);

            // Show the container
            document.getElementById('emailInputsContainer').style.display = 'block';
        }

        // Function to remove an email field
        function removeField(button) {
            const emailInputDiv = button.closest('.input-group');
            emailInputDiv.remove();
        }

        // Function to send invites
        function sendInvites(testId) {
            const emailInputsForm = document.getElementById('emailInputsForm');
            const emailInputs = emailInputsForm.querySelectorAll('input[type="email"]');
            const emails = [];

            // Check if the form is valid
            let isValid = true;
            emailInputs.forEach(input => {
                if (!input.checkValidity()) {
                    isValid = false;
                    input.reportValidity(); // Trigger browser validation message
                } else {
                    emails.push(input.value.trim());
                }
            });

            if (!isValid || emails.length === 0) {
                return;
            }

            // Send the emails to the server
            fetch(`/TestInvite/SendInvites?testId=${testId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(emails),
            })
                .then(response => {
                    if (response.ok) {
                        alert('Invites sent successfully!');
                    } else {
                        alert('Error sending invites.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error sending invites.');
                });
        }
    </script>
}